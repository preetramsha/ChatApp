# Use lightweight Node.js image
FROM node:24-alpine3.21

# Set working directory
WORKDIR /app

# Copy only package.json first (for better caching)
COPY package.json .

# Install dependencies
RUN npm install

# Copy rest of the app
COPY . .

# Optional volumes for persistent data
VOLUME ["/app/chatData", "/app/src/db"]

# Set environment variable for DB file
ENV DB_FILE_NAME=file:/app/src/db/chatappsqlite.db

# Run DB migrations (if they exist)
RUN npm run migrate -- --config=drizzle.config.js || echo "No migrations to run"

# Expose app port
EXPOSE 3000

# Start the app
CMD ["npm", "start"]
